name: UI Tests

on:
  workflow_dispatch:
      inputs:
        deployment_target:
          description: Choose target
          required: true
          default: good
          type: choice
          options:
            - good
            - bad

jobs:
  ui-tests:
    runs-on: ubuntu-latest
    outputs:
      good: ${{ steps.good.outcome }}
      bad: ${{ steps.bad.outcome }}
    steps:
      - uses: actions/checkout@v2

      - name: Checkout (copy) gh-pages repository to GitHub runner
        uses: actions/checkout@v2
        with:
            ref: gh-pages
            path: ./.github/gh-pages
      - name: install dependencies
        run: pip install -r requirements.txt
      - name: good
        id: good
        if: "github.event.inputs.deployment_target == 'good'"
        run: pytest -m good --alluredir=allure-results
        continue-on-error: true
      - name: bad
        id: bad
        if: "github.event.inputs.deployment_target == 'bad'"
        run: pytest -m bad --alluredir=allure-results
        continue-on-error: true
      - name: Run UI-tests via docker-compose
        env:
          LOGIN: ${{ secrets.LOGIN }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          docker-compose up --exit-code-from regression || true

      - name: Copy history from gh-pages to allure-results
        run: |
          sudo mkdir -p allure-results/history  # Создает директорию для истории Allure
          sudo cp -R ./.github/gh-pages/history/* allure-results/history/

      - name: Generate Allure report
        run: |
          sudo docker-compose run regression /bin/sh -c "allure generate allure-results --clean -o allure-report"
      - name: success
        if: needs.test.outputs.good != 'failure' && needs.test.outputs.bad != 'failure'
        run: |
          curl --location 'https://hooks.slack.com/services/${{ secrets.st_slack }}' --header 'Content-Type:application/json' --data '{"text": ":white_check_mark: Тестирование завершено. Отчет доступен здесь: https://rustambek-dot.github.io/LiveCoding/"}'
      - name: failure
        if: needs.test.outputs.good == 'failure' || needs.test.outputs.bad == 'failure'
        run: |
          curl --location 'https://hooks.slack.com/services/${{ secrets.st_slack }}' --header 'Content-Type:application/json' --data '{"text": ":rage: Тестирование завершено. Отчет доступен здесь: https://rustambek-dot.github.io/LiveCoding/"}'


      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          token: ${{ secrets.CI_TOKEN1 }}
          branch: gh-pages
          folder: allure-report
          clean: true
